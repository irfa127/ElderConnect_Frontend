<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile | ElderConnect</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">

    <div class="sidebar" id="dynamicSidebar">
    
    </div>

    <main class="main-content">
      <header class="section-head">
        <h1 class="page-title">Personal Profile</h1>
        <button class="btn btn-primary" onclick="showToast('Profile Updated!')">
          Save Changes
        </button>
      </header>

      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px">
     
        <div class="glass-card animate-slide" style="text-align: center">
          <div style="position: relative; display: inline-block">
            <img id="profileAvatar" src="https://ui-avatars.com/api/?name=User&size=150" style="
                  width: 150px;
                  height: 150px;
                  border-radius: 50%;
                  border: 5px solid var(--primary-light);
                " />
            <button class="btn btn-primary" style="
                  position: absolute;
                  bottom: 5px;
                  right: 5px;
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  padding: 0;
                  justify-content: center;
                ">
              <i class="fas fa-camera"></i>
            </button>
          </div>
          <h2 id="profileName" style="margin-top: 20px; font-weight: 800">
            Loading...
          </h2>
          <p id="profileRole" style="color: var(--text-muted); font-weight: 700"></p>
        </div>

        <!-- Info Card -->
        <div class="glass-card animate-slide" style="animation-delay: 0.1s">
          <h3 style="font-weight: 800; margin-bottom: 25px">
            Basic Information
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
            <div>
              <label style="
                    display: block;
                    font-size: 0.8rem;
                    font-weight: 700;
                    color: var(--text-muted);
                    margin-bottom: 8px;
                  ">Full Name</label>
              <input type="text" class="btn-outline" value="" id="inputName"
                style="width: 100%; padding: 12px; border-radius: 10px" />
            </div>
            <div>
              <label style="
                    display: block;
                    font-size: 0.8rem;
                    font-weight: 700;
                    color: var(--text-muted);
                    margin-bottom: 8px;
                  ">Email Address</label>
              <input type="email" class="btn-outline" value="" id="inputEmail"
                style="width: 100%; padding: 12px; border-radius: 10px" />
            </div>
            <div>
              <label
                style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px;">Phone
                Number</label>
              <input type="text" class="btn-outline" value="" id="inputPhone"
                style="width: 100%; padding: 12px; border-radius: 10px" placeholder="+1 (555) 000-0000" />
            </div>
            <div>
              <label
                style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px;">Address</label>
              <input type="text" class="btn-outline" value="" id="inputAddress"
                style="width: 100%; padding: 12px; border-radius: 10px" placeholder="City, State" />
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden File Input -->
      <input type="file" id="avatarInput" style="display: none;" accept="image/*" onchange="uploadAvatar(this)">

    </main>
  </div>

  <script src="../js/main.js"></script>
  <script>
    const API_URL = "http://localhost:8000";
    let currentUser = null;

    document.addEventListener("DOMContentLoaded", async () => {
      const userStr = localStorage.getItem("user");
      if (!userStr) { window.location.href = "login.html"; return; }
      currentUser = JSON.parse(userStr);

    
      const sidebar = document.getElementById("dynamicSidebar");
      sidebar.innerHTML = `
            <a href="index.html" class="nav-brand"><i class="fas fa-hand-holding-medical"></i> ElderConnect</a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="patient-dashboard.html" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-item"><a href="patient-appointments.html" class="nav-link"><i class="fas fa-calendar-check"></i> Appointments</a></li>
                <li class="nav-item"><a href="patient-senior-living.html" class="nav-link"><i class="fas fa-hotel"></i> Senior Living</a></li>
                <li class="nav-item"><a href="patient-vitals.html" class="nav-link"><i class="fas fa-chart-line"></i> Health Vitals</a></li>
                <li class="nav-item"><a href="patient-profile.html" class="nav-link active"><i class="fas fa-user-circle"></i> My Profile</a></li>
                <li class="nav-item"><a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        `;

      await loadProfile();

   
      document.querySelector(".section-head .btn-primary").onclick = updateProfile;
 
      document.querySelector(".fas.fa-camera").parentElement.onclick = () => {
        document.getElementById("avatarInput").click();
      };
    });

    async function loadProfile() {
      try {
        const res = await fetch(`${API_URL}/users/${currentUser.id}`);
        if (res.ok) {
          const user = await res.json();
          currentUser = user;
          localStorage.setItem("user", JSON.stringify(user));

          document.getElementById("profileName").innerText = user.full_name;
          document.getElementById("profileRole").innerText = user.role.toUpperCase();

          if (user.profile_picture) {
            let src = user.profile_picture;
            if (src.startsWith("/static")) src = API_URL + src;
            document.getElementById("profileAvatar").src = src;
          } else {
            document.getElementById("profileAvatar").src = `https://ui-avatars.com/api/?name=${user.full_name}&background=eff6ff&color=3b82f6&size=150`;
          }

          document.getElementById("inputName").value = user.full_name;
          document.getElementById("inputEmail").value = user.email;
          document.getElementById("inputPhone").value = user.phone || "";
          document.getElementById("inputAddress").value = user.address || "";
        }
      } catch (e) {
        console.error("Error loading profile", e);
      }
    }

    async function uploadAvatar(input) {
      if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append("file", input.files[0]);

        try {
          const res = await fetch(`${API_URL}/uploads/`, {
            method: "POST",
            body: formData
          });

          if (res.ok) {
            const data = await res.json();
            let imgUrl = data.url;
            document.getElementById("profileAvatar").src = API_URL + imgUrl;  //UI la image change (instant preview)
            await updateProfilePicture(imgUrl);
          } else {
            showToast("Upload failed", "error");
          }
        } catch (e) {
          console.error(e);
          showToast("Connection error", "error");
        }
      }
    }

    async function updateProfilePicture(url) {
      try {
        const response = await fetch(`${API_URL}/users/${currentUser.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ profile_picture: url })
        });
        if (response.ok) showToast("Avatar updated!");
      } catch (e) { console.error(e); }
    }

    async function updateProfile() {
      const newName = document.getElementById("inputName").value;
      const newEmail = document.getElementById("inputEmail").value;
      const newPhone = document.getElementById("inputPhone").value;
      const newAddress = document.getElementById("inputAddress").value;

      try {
        const response = await fetch(`${API_URL}/users/${currentUser.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            full_name: newName,
            email: newEmail,
            phone: newPhone,
            address: newAddress
          })
        });

        if (response.ok) {
          showToast("Profile Updated Successfully!");
          await loadProfile();
        } else {
          showToast("Failed to update profile", "error");
        }
      } catch (e) {
        console.error(e);
        showToast("Connection Error", "error");
      }
    }
  </script>
</body>

</html>
