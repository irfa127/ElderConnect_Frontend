<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patients | ElderConnect Nurse</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/nurse.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .search-bar {
      background: white;
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      width: 350px;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="index.html" class="nav-brand">
        <i class="fas fa-hand-holding-medical"></i> ElderConnect
      </a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="nurse-dashboard.html" class="nav-link"><i class="fas fa-columns"></i> Dashboard</a>
        </li>
        <li class="nav-item">
          <a href="nurse-portal.html" class="nav-link"><i class="fas fa-calendar-check"></i> Appointment Portal</a>
        </li>
        <li class="nav-item">
          <a href="nurse-patients.html" class="nav-link active"><i class="fas fa-users"></i> Patient History</a>
        </li>
        <li class="nav-item">
          <a href="nurse-profile.html" class="nav-link"><i class="fas fa-user-md"></i> My Profile</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </div>

    <main class="main-content">
      <header class="section-head">
        <h1 class="page-title">Patient Records</h1>
        <div class="search-bar">
          <i class="fas fa-search" style="color: var(--text-muted)"></i>
          <input type="text" placeholder="Search by name or ID..." style="
                border: none;
                outline: none;
                width: 100%;
                font-size: 0.9rem;
              " />
        </div>
      </header>

      <table class="patient-table animate-slide">
        <thead>
          <tr>
            <th>Patient Name</th>
            <th>Record ID</th>
            <th>Last Visit</th>
            <th>Service Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="patientsTableBody">
          <tr>
            <td colspan="6" style="text-align:center; padding: 20px;">Loading patients...</td>
          </tr>
        </tbody>
      </table>
    </main>
  </div>

  <script src="../js/main.js"></script>
  <script>
    const API_URL = "http://localhost:8000";

    let isFetching = false;

    document.addEventListener("DOMContentLoaded", () => {
      const userStr = localStorage.getItem("user");
      if (!userStr) { window.location.href = 'login.html'; return; }
      const nurse = JSON.parse(userStr);

      if (nurse.role !== 'nurse') {
        alert("Access Denied");
        window.location.href = 'index.html';
        return;
      }

      fetchPatientHistory(nurse.id);
      setInterval(() => fetchPatientHistory(nurse.id), 5000);
    });

    async function fetchPatientHistory(nurseId) {
      if (isFetching) return;
      isFetching = true;

      try {
        // 1. Fetch appointments to find which patients this nurse sees
        const appResponse = await fetch(`${API_URL}/appointments/nurse/${nurseId}`);
        if (!appResponse.ok) throw new Error("Failed to fetch appointments");
        const appointments = await appResponse.json();

        // 2. Extract unique patient IDs and latest visit info
        const patientMap = new Map();

        appointments.forEach(appt => {
          const pid = appt.patient_id;
          const date = new Date(appt.appointment_date);

          if (!patientMap.has(pid) || date > patientMap.get(pid).lastVisitDate) {
            patientMap.set(pid, {
              lastVisitDate: date,
              lastVisitStr: date.toLocaleDateString(),
              serviceType: appt.service_type || "General Checkup",
              status: appt.status
            });
          }
        });

        if (patientMap.size === 0) {
          document.getElementById("patientsTableBody").innerHTML =
            `<tr><td colspan="6" style="text-align:center; padding: 20px;">No patients found in your history.</td></tr>`;
          return;
        }

        // 3. Simple Rebuild (can optimize later)
        const tableBody = document.getElementById("patientsTableBody");
        // We'll build HTML string first then inject to minimize partial rendering
        let rowsHtml = "";

        // Note: For a real app, we'd fetch patient details in bulk or batch.
        // For now loop is okay for small sets.
        for (let [pid, info] of patientMap) {
          try {
            const userResponse = await fetch(`${API_URL}/users/${pid}`);
            if (userResponse.ok) {
              const patient = await userResponse.json();
              const statusColor = info.status === 'completed' ? 'success' : (info.status === 'scheduled' ? 'info' : 'warning');

              rowsHtml += `
                                <tr class="animate-fade">
                                  <td>
                                    <div style="display: flex; align-items: center; gap: 12px">
                                      <img
                                        src="https://ui-avatars.com/api/?name=${patient.full_name}&background=eff6ff&color=3b82f6"
                                        style="width: 32px; height: 32px; border-radius: 50%"
                                      />
                                      <span style="font-weight: 700">${patient.full_name}</span>
                                    </div>
                                  </td>
                                  <td style="color: var(--primary); font-weight: 600">#PT-${patient.id}</td>
                                  <td>${info.lastVisitStr}</td>
                                  <td>${info.serviceType}</td>
                                  <td><span class="badge badge-${statusColor}">${info.status.toUpperCase()}</span></td>
                                  <td>
                                    <button
                                      class="btn btn-outline btn-small"
                                      style="padding: 6px 12px; font-size: 0.75rem"
                                      onclick="alert('View History feature coming soon for Patient #${patient.id}')"
                                    >
                                      VIEW HISTORY
                                    </button>
                                  </td>
                                </tr>
                            `;
            }
          } catch (e) { console.error(e); }
        }

        tableBody.innerHTML = rowsHtml;

      } catch (e) {
        console.error("Error loading patients page:", e);
      } finally {
        isFetching = false;
      }
    }
  </script>
</body>

</html>
