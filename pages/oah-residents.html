<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resident List | ElderConnect</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/nurse.css" />
  <!-- Reusing table styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="index.html" class="nav-brand">
        <i class="fas fa-hand-holding-medical"></i> ElderConnect
      </a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="oah-dashboard.html" class="nav-link"><i class="fas fa-columns"></i> Overview</a>
        </li>
        <li class="nav-item">
          <a href="oah-portal.html" class="nav-link"><i class="fas fa-hotel"></i> Manage Home</a>
        </li>
        <li class="nav-item">
          <a href="oah-inquiries.html" class="nav-link"><i class="fas fa-envelope-open-text"></i> Inquiries</a>
        </li>
        <li class="nav-item">
          <a href="oah-residents.html" class="nav-link active"><i class="fas fa-users-cog"></i> Resident List</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </div>

    <main class="main-content">
      <header class="section-head">
        <h1 class="page-title">Current Residents</h1>
        <button class="btn btn-primary" style="background: #059669" onclick="showToast('Feature Coming Soon')">
          Add New Resident
        </button>
      </header>

      <div class="glass-card animate-slide">
        <table class="patient-table">
          <thead>
            <tr>
              <th>Resident Name</th>
              <th>Email</th>
              <th>Join Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="residentsTableBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px;">Loading residents...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
  <script>
    const API_URL = "http://localhost:8000";

    document.addEventListener("DOMContentLoaded", async () => {
      const userStr = localStorage.getItem("user");
      if (!userStr) { window.location.href = 'login.html'; return; }
      const user = JSON.parse(userStr);

      try {
        // 1. Get Community ID
        const commResponse = await fetch(`${API_URL}/communities/manager/${user.id}`);
        const comms = await commResponse.json();
        if (!comms || comms.length === 0) {
          document.getElementById("residentsTableBody").innerHTML =
            `<tr><td colspan="5" style="text-align: center;">No community found.</td></tr>`;
          return;
        }
        const commId = comms[0].id;

        // 2. Get Inquiries (Accepted ones are residents)
        const inqResponse = await fetch(`${API_URL}/inquiries/community/${commId}`);
        const inquiries = await inqResponse.json();

        const residents = inquiries.filter(i => i.status === 'accepted');

        renderResidents(residents);

      } catch (e) {
        console.error(e);
        document.getElementById("residentsTableBody").innerHTML =
          `<tr><td colspan="5" style="text-align: center; color: red;">Error loading residents.</td></tr>`;
      }
    });

    async function renderResidents(items) {
      const tbody = document.getElementById("residentsTableBody");
      tbody.innerHTML = "";

      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No residents yet (Accepted inquiries appear here).</td></tr>`;
        return;
      }

      for (const item of items) {
        try {
          const res = await fetch(`${API_URL}/users/${item.patient_id}`);
          const patient = await res.json();

          const row = `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px">
                                    <img src="https://ui-avatars.com/api/?name=${patient.full_name}&background=059669&color=fff" style="width: 32px; height: 32px; border-radius: 50%" />
                                    <span style="font-weight: 700">${patient.full_name}</span>
                                </div>
                            </td>
                            <td>${patient.email}</td>
                            <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            <td><span class="badge badge-success">RESIDENT</span></td>
                            <td>
                                <button class="btn btn-outline btn-small" onclick="window.location.href='oah-patient-details.html?id=${patient.id}'">
                                    View Profile
                              </button>
                            </td>
                        </tr>
                    `;
          tbody.insertAdjacentHTML('beforeend', row);
        } catch (e) {
          console.error("Failed to load resident", e);
        }
      }
    }
  </script>
  </main>
  </div>
  <script src="../js/main.js"></script>
</body>

</html>
