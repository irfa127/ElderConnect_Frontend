<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Details | ElderConnect</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="index.html" class="nav-brand">
                <i class="fas fa-hand-holding-medical"></i> ElderConnect
            </a>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="patient-dashboard.html" class="nav-link"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="nav-item">
                    <a href="patient-appointments.html" class="nav-link"><i class="fas fa-calendar-check"></i>
                        Appointments</a>
                </li>
                <li class="nav-item">
                    <a href="patient-senior-living.html" class="nav-link active"><i class="fas fa-hotel"></i> Senior
                        Living</a>
                </li>
                <li class="nav-item">
                    <a href="patient-vitals.html" class="nav-link"><i class="fas fa-chart-line"></i> Health Vitals</a>
                </li>
                <li class="nav-item">
                    <a href="patient-profile.html" class="nav-link"><i class="fas fa-user-circle"></i> My Profile</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <header class="section-head">
                <h1 class="page-title">Community Details</h1>
                <a href="patient-senior-living.html" class="btn btn-outline">Back to List</a>
            </header>

            <div id="detailsContainer" class="animate-slide">
                <p style="text-align: center; color: var(--text-muted);">Loading details...</p>
            </div>

            <!-- Inquiry Modal -->
            <div id="inquiryModal" class="modal">
                <div class="modal-content animate-slide">
                    <span class="close-modal" onclick="closeModal('inquiryModal')">&times;</span>
                    <h2>Book a Visit / Inquire</h2>
                    <form id="inquiryForm" style="margin-top: 20px;">
                        <input type="hidden" id="communityId" />

                        <div class="form-group">
                            <label class="form-label">Resident Name</label>
                            <input type="text" class="form-input" id="residentName" required
                                placeholder="Name of the person moving in" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Resident Age</label>
                            <input type="number" class="form-input" id="residentAge" required placeholder="Age" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Relationship to Applicant</label>
                            <select class="form-input" id="relation">
                                <option value="Self">Self</option>
                                <option value="Parent">Parent</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Relative">Relative</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Medical Needs / Notes</label>
                            <textarea class="form-input" id="medicalNeeds"
                                placeholder="Describe any specific care requirements..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Submit
                            Inquiry</button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script src="../js/main.js"></script>
    <script>
        const API_URL = "http://localhost:8000";

        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get("id");
            const container = document.getElementById("detailsContainer");

            if (!id) {
                container.innerHTML = "<p>Community not specified.</p>";
                return;
            }

            try {
                const response = await fetch(`${API_URL}/communities/${id}`);
                if (!response.ok) throw new Error("Failed to fetch details");
                const comm = await response.json();

                container.innerHTML = `
          <div class="glass-card" style="margin-bottom: 24px;">
             <img src="${comm.image_url || 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800'}" 
                  style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px; margin-bottom: 20px;" />
             <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 10px;">${comm.name}</h2>
             <p style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 20px;">
                <i class="fas fa-map-marker-alt"></i> ${comm.location}
             </p>
             <p style="line-height: 1.6; margin-bottom: 20px;">
                ${comm.description}
             </p>

             <div style="display: flex; gap: 20px; padding: 20px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; margin-bottom: 30px;">
                <div>
                   <span style="display: block; font-size: 0.85rem; color: var(--text-muted);">Pricing</span>
                   <strong style="font-size: 1.2rem; color: var(--primary);">${comm.pricing || "Contact for pricing"}</strong>
                </div>
                <div>
                   <span style="display: block; font-size: 0.85rem; color: var(--text-muted);">Contact</span>
                   <strong style="font-size: 1.2rem; color: var(--text-main);">${(comm.phone && comm.phone.trim() !== "") ? comm.phone : "Contact Admin"}</strong>
                </div>
             </div>

             <button class="btn btn-primary" onclick="openInquiryModal(${comm.id})">
                <i class="fas fa-paper-plane"></i> Send Inquiry
             </button>
          </div>
        `;

                // Pre-fill user data if desired
                const userStr = localStorage.getItem("user");
                if (userStr) {
                    const user = JSON.parse(userStr);
                    // Could store user info in form hidden fields if needed, 
                    // but inquiry needs applicant_name/phone/email from user object.
                    // We will handle this in submit.
                }

            } catch (e) {
                container.innerHTML = "<p style='color: red;'>Error loading details.</p>";
            }

            // Inquiry Form Handler
            document.getElementById("inquiryForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const userStr = localStorage.getItem("user");
                if (!userStr) { alert("Please login first"); return; }
                const user = JSON.parse(userStr);

                const communityId = document.getElementById("communityId").value;
                const data = {
                    community_id: communityId,
                    patient_id: user.id,
                    applicant_name: user.full_name,
                    applicant_email: user.email,
                    applicant_phone: user.phone_number || "N/A",
                    resident_name: document.getElementById("residentName").value,
                    resident_age: document.getElementById("residentAge").value,
                    relation: document.getElementById("relation").value,
                    medical_needs: document.getElementById("medicalNeeds").value,
                    status: "pending"
                };

                try {
                    const res = await fetch(`${API_URL}/inquiries/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        alert("Inquiry Sent Successfully! The manager will contact you.");
                        closeModal("inquiryModal");
                    } else {
                        const err = await res.json();
                        alert("Failed: " + (err.detail || "Server Error"));
                    }
                } catch (ex) {
                    console.error(ex);
                    alert("Connection Error");
                }
            });
        });

        function openInquiryModal(id) {
            document.getElementById("communityId").value = id;
            openModal("inquiryModal");
        }
    </script>
</body>

</html>
