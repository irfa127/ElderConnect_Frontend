<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inquiries | ElderConnect</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/oah.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="index.html" class="nav-brand">
        <i class="fas fa-hand-holding-medical"></i> ElderConnect
      </a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="oah-dashboard.html" class="nav-link"><i class="fas fa-columns"></i> Overview</a>
        </li>
        <li class="nav-item">
          <a href="oah-portal.html" class="nav-link"><i class="fas fa-hotel"></i> Manage Home</a>
        </li>
        <li class="nav-item">
          <a href="oah-inquiries.html" class="nav-link active"><i class="fas fa-envelope-open-text"></i> Inquiries</a>
        </li>
        <li class="nav-item">
          <a href="oah-residents.html" class="nav-link"><i class="fas fa-users-cog"></i> Resident List</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </div>

    <main class="main-content">
      <header class="section-head">
        <h1 class="page-title">New Management Inquiries</h1>
        <div style="display: flex; gap: 10px">
          <button class="btn btn-outline">Filter: Newest</button>
          <button class="btn btn-primary" style="background: #059669">
            Download Log
          </button>
        </div>
      </header>

      <div class="glass-card animate-slide">
        <table class="patient-table">
          <thead>
            <tr>
              <th>Applicant</th>
              <th>Status</th>
              <th>Message</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inquiriesTableBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px;">Loading inquiries...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
  <script>
    const API_URL = "http://localhost:8000";

    document.addEventListener("DOMContentLoaded", async () => {
      const userStr = localStorage.getItem("user");
      if (!userStr) { window.location.href = 'login.html'; return; }
      const user = JSON.parse(userStr);

      try {
        // 1. Get Community ID
        const commResponse = await fetch(`${API_URL}/communities/manager/${user.id}`);
        const comms = await commResponse.json();
        if (!comms || comms.length === 0) {
          document.getElementById("inquiriesTableBody").innerHTML =
            `<tr><td colspan="5" style="text-align: center; padding: 20px;">No community found. Please setup in Manage Home.</td></tr>`;
          return;
        }
        const commId = comms[0].id;

        // 2. Get Inquiries
        const inqResponse = await fetch(`${API_URL}/inquiries/community/${commId}`);
        const inquiries = await inqResponse.json();

        renderInquiries(inquiries);

      } catch (e) {
        console.error(e);
        document.getElementById("inquiriesTableBody").innerHTML =
          `<tr><td colspan="5" style="text-align: center; color: red;">Error loading data.</td></tr>`;
      }
    });

    async function renderInquiries(inquiries) {
      const tbody = document.getElementById("inquiriesTableBody");
      tbody.innerHTML = "";

      if (inquiries.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No inquiries found.</td></tr>`;
        return;
      }

      // Fetch patient names for all inquiries
      // Parallel fetch for better performance
      const enrichedInquiries = await Promise.all(inquiries.map(async (inq) => {
        try {
          const res = await fetch(`${API_URL}/users/${inq.patient_id}`);
          const user = await res.json();
          return { ...inq, patientName: user.full_name };
        } catch (e) {
          return { ...inq, patientName: "Unknown User" };
        }
      }));

      enrichedInquiries.reverse().forEach(inq => {
        const date = new Date(inq.created_at).toLocaleDateString(); // assuming created_at exists, else use current
        const badgeClass = inq.status === 'accepted' ? 'success' : (inq.status === 'rejected' ? 'danger' : 'info');

        const row = `
                  <tr>
                    <td><strong>${inq.patientName}</strong></td>
                    <td><span class="badge badge-${badgeClass}">${inq.status.toUpperCase()}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${inq.message || "-"}</td>
                    <td>${date}</td>
                    <td>
                      ${inq.status === 'pending' ? `
                          <button class="btn btn-primary btn-small" style="background: #059669; padding: 5px 10px;" onclick="updateStatus(${inq.id}, 'accepted')">Accept</button>
                          <button class="btn btn-outline btn-small" style="color: #ef4444; border-color: #ef4444; padding: 5px 10px;" onclick="updateStatus(${inq.id}, 'rejected')">Reject</button>
                      ` : `<span style="font-size: 0.8rem; color: #64748b;">Completed</span>`}
                    </td>
                  </tr>
                `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    async function updateStatus(id, status) {
      if (!confirm(`Mark inquiry as ${status}?`)) return;
      try {
        const response = await fetch(`${API_URL}/inquiries/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });

        if (response.ok) {
          showToast(`Inquiry ${status}`);
          // Reload
          location.reload();
        } else {
          showToast("Failed to update status");
        }
      } catch (e) {
        console.error(e);
        showToast("Error updating status");
      }
    }
  </script>
  </main>
  </div>
  <script src="../js/main.js"></script>
</body>

</html>
