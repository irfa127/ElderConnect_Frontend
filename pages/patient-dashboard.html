<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | ElderConnect Patient</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/patient.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <div class="app-container">
      <div class="sidebar">
        <a href="index.html" class="nav-brand">
          <i class="fas fa-hand-holding-medical"></i> ElderConnect
        </a>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="patient-dashboard.html" class="nav-link active"
              ><i class="fas fa-home"></i> Home</a
            >
          </li>
          <li class="nav-item">
            <a href="patient-appointments.html" class="nav-link"
              ><i class="fas fa-calendar-check"></i> Appointments</a
            >
          </li>
          <li class="nav-item">
            <a href="patient-senior-living.html" class="nav-link"
              ><i class="fas fa-hotel"></i> Senior Living</a
            >
          </li>
          <li class="nav-item">
            <a href="patient-vitals.html" class="nav-link"
              ><i class="fas fa-chart-line"></i> Health Vitals</a
            >
          </li>
          <li class="nav-item">
            <a href="patient-profile.html" class="nav-link"
              ><i class="fas fa-user-circle"></i> My Profile</a
            >
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link logout-link"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </li>
        </ul>
      </div>

      <main class="main-content">
        <header class="section-head">
          <div>
            <h1 class="page-title" id="user-greeting">Hello, Patient ðŸ‘‹</h1>
            <p style="color: var(--text-muted); margin-top: 5px">
              You have one appointment scheduled for today.
            </p>
          </div>

          <div style="display: flex; gap: 15px">
            <img
              id="user-avatar"
              src="https://ui-avatars.com/api/?name=User&background=eff6ff&color=3b82f6"
              alt="Profile"
              style="
                width: 48px;
                height: 48px;
                border-radius: 12px;
                border: 2px solid white;
                box-shadow: var(--card-shadow);
              "
            />
          </div>
        </header>

        <div
          id="liveTrackingContainer"
          class="tracking-container animate-slide"
          style="display: none"
        >
          <div class="tracking-title">
            <span class="badge badge-success" style="padding: 5px 10px"
              >LIVE</span
            >
            Nurse Arrival Tracking
            <span
              id="txt-eta"
              style="
                margin-left: auto;
                color: var(--primary);
                font-size: 0.9rem;
              "
              >Estimated: 15 mins</span
            >
          </div>

          <div class="timeline">
            <div class="timeline-line">
              <div class="line-progress" id="progress-bar"></div>
            </div>

            <div class="timeline-step">
              <div class="step-icon completed">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="step-label">Booked</div>
            </div>

            <div class="timeline-step">
              <div class="step-icon" id="icon-way">
                <i class="fas fa-car-side"></i>
              </div>
              <div class="step-label">On Way</div>
            </div>

            <div class="timeline-step">
              <div class="step-icon" id="icon-arrived">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="step-label">Arrived</div>
            </div>

            <div class="timeline-step">
              <div class="step-icon" id="icon-completed">
                <i class="fas fa-file-medical"></i>
              </div>
              <div class="step-label">Complete</div>
            </div>
          </div>

          <div style="margin-top: 30px; text-align: center">
            <h3
              id="status-text"
              style="font-size: 1.1rem; font-weight: 800; color: #1e293b"
            >
              Nurse is preparing...
            </h3>
            <p style="color: #64748b; font-size: 0.9rem; margin-top: 5px">
              Dr. Alice Smith â€¢
              <a href="#" style="color: var(--primary)">Contact</a>
            </p>
          </div>
        </div>

        <div
          id="nurseBusyWarning"
          class="animate-slide"
          style="display: none; margin-top: 20px"
        >
          <div
            class="glass-card"
            style="
              background: #fff1f2;
              border-color: #fda4af;
              display: flex;
              gap: 15px;
              align-items: start;
            "
          >
            <div
              style="
                background: #fee2e2;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
              "
            >
              <i
                class="fas fa-user-clock"
                style="color: #be123c; font-size: 1.2rem"
              ></i>
            </div>
            <div>
              <h3
                style="
                  color: #be123c;
                  font-weight: 800;
                  font-size: 1rem;
                  margin-bottom: 5px;
                "
              >
                Nurse Currently Busy
              </h3>
              <p style="color: #9f1239; font-size: 0.9rem; line-height: 1.5">
                Your nurse is currently attending another patient at this
                scheduled time. Please wait, they will update their status soon.
              </p>
            </div>
          </div>
        </div>

        <div class="stats-grid" style="margin-top: 30px">
          <div class="stat-card">
            <span class="stat-label">Blood Pressure</span>
            <div class="stat-value" style="color: var(--primary)" id="dash-bp">
              --
            </div>
            <span class="badge badge-success" id="dash-bp-status">Normal</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Heart Rate</span>
            <div class="stat-value" style="color: var(--danger)" id="dash-hr">
              -- <small style="font-size: 1rem">BPM</small>
            </div>
            <span class="badge badge-warning" id="dash-hr-status">--</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Last Sugar Level</span>
            <div
              class="stat-value"
              style="color: var(--success)"
              id="dash-sugar"
            >
              -- <small style="font-size: 1rem">mg/dL</small>
            </div>
            <span class="badge badge-success" id="dash-sugar-status">--</span>
          </div>
        </div>

        <div
          style="
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-top: 30px;
          "
        >
          <div class="glass-card animate-slide">
            <h3
              style="font-weight: 800; font-size: 1.2rem; margin-bottom: 20px"
            >
              Recent Reports
            </h3>
            <ul style="list-style: none" id="reportsList">
              <li style="text-align: center; color: var(--text-muted)">
                No reports available.
              </li>
            </ul>
            <a
              href="patient-vitals.html"
              class="btn btn-outline"
              style="width: 100%; justify-content: center"
              >View All Records</a
            >
          </div>
        </div>
      </main>
    </div>

    <script src="../js/main.js"></script>
    <script>
      const API_URL = "http://localhost:8000";
      let isRequestInProgress = false; // every 5 second dashboard refresh aagum

      document.addEventListener("DOMContentLoaded", () => {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
          window.location.href = "login.html";
          return;
        }
        const user = JSON.parse(userStr);

        if (user.role !== "patient") {
          document.body.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#f8fafc; font-family:sans-serif;">
                <div style="background:white; padding:40px; border-radius:20px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.1); text-align:center; max-width:400px;">
                    <div style="width:60px; height:60px; background:#fee2e2; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                         <i class="fas fa-user-lock" style="color:#ef4444; font-size:24px;"></i>
                    </div>
                    <h2 style="color:#1e293b; margin-bottom:10px;">Session Changed</h2>
                    <p style="color:#64748b; line-height:1.6; margin-bottom:25px;">
                        A different user (${user.role.replace("_", " ")}) is currently logged in. Please log in again to access your dashboard.
                    </p>
                    <button onclick="localStorage.clear(); window.location.href='login.html'" 
                        style="width:100%; padding:14px; background:#3b82f6; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:700; font-size:1rem;">
                        Go to Login
                    </button>
                </div>
            </div>
          `;
          return;
        }

        document.getElementById("user-greeting").innerText =
          `Hello, ${user.full_name} ðŸ‘‹`;

        refreshDashboard(user.id);

        setInterval(() => {
          const storedUser = localStorage.getItem("user");
          if (!storedUser) {
            window.location.href = "login.html";
            return;
          }
          const parsed = JSON.parse(storedUser);
          if (parsed.id !== user.id) {
            console.warn("Session changed, reloading...");
            window.location.reload();
            return;
          }
          refreshDashboard(user.id);
        }, 5000);
      });

      async function refreshDashboard(userId) {
        if (isRequestInProgress) return;
        isRequestInProgress = true;

        try {
          console.log("Fetching appointments for patient:", userId);
          const aptResponse = await fetch(
            `${API_URL}/appointments/patient/${userId}?t=${new Date().getTime()}`, // ?t= browser cache avoid panna
          );
          if (aptResponse.ok) {
            const appointments = await aptResponse.json();

            const activeStatuses = [
              "pending",
              "confirmed",
              "on-the-way",
              "arrived",
            ];
            const activeApts = appointments.filter((a) =>
              activeStatuses.includes(a.status),
            );

            activeApts.sort((a, b) => {
              const priority = {
                arrived: 4,
                "on-the-way": 3,
                confirmed: 2,
                pending: 1,
              };

              if (priority[b.status] !== priority[a.status]) {
                return priority[b.status] - priority[a.status];
              }

              return b.id - a.id;
            });

            const activeApt = activeApts.length > 0 ? activeApts[0] : null;

            const warningEl = document.getElementById("nurseBusyWarning");
            if (warningEl) warningEl.style.display = "none";

            if (
              activeApt &&
              (activeApt.status === "pending" ||
                activeApt.status === "confirmed")
            ) {
              (async () => {
                try {
                  const nurseApptsRes = await fetch(
                    `${API_URL}/appointments/nurse/${activeApt.nurse_id}`,
                  );
                  if (nurseApptsRes.ok) {
                    const nurseAppts = await nurseApptsRes.json();

                    //some() na Oru appointment-achum match aanaa TRUE
                    const isBusy = nurseAppts.some((apt) => {
                      if (apt.id === activeApt.id) return false;

                      const isActive = ["ON_THE_WAY", "ARRIVED"].includes(
                        apt.status.toUpperCase(),
                      );
                      if (!isActive) return false;

                      const date1 = new Date(
                        apt.appointment_date,
                      ).toDateString();
                      const date2 = new Date(
                        activeApt.appointment_date,
                      ).toDateString();

                      return (
                        date1 === date2 &&
                        apt.appointment_time === activeApt.appointment_time
                      );
                    });

                    if (isBusy && warningEl) {
                      warningEl.style.display = "block";
                    }
                  }
                } catch (e) {
                  console.error("Error checking nurse availability", e);
                }
              })();
            }

            if (!activeApt) {
              document.querySelector(".page-title + p").innerText =
                "You have no active appointments right now.";
            }
          }

          // Fetch Vitals
          const vitalsResponse = await fetch(
            `${API_URL}/vitals/patient/${userId}`,
          );
          if (vitalsResponse.ok) {
            const vitals = await vitalsResponse.json();
            if (vitals.length > 0) {
              const latest = vitals[0];

              document.getElementById("dash-bp").innerText =
                latest.blood_pressure || "--";
              document.getElementById("dash-hr").innerHTML =
                `${latest.heart_rate || "--"} <small style="font-size: 1rem">BPM</small>`;
              document.getElementById("dash-sugar").innerHTML =
                `${latest.sugar_level || "--"} <small style="font-size: 1rem">mg/dL</small>`;

              document.getElementById("reportsList").innerHTML = `
                      <li style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                        <i class="fas fa-file-medical-alt" style="color: var(--primary); font-size: 1.5rem"></i>
                        <div>
                          <p style="font-weight: 700; font-size: 0.9rem">Health Summary</p>
                          <p style="font-size: 0.75rem; color: var(--text-muted)">Latest reading recorded</p>
                        </div>
                      </li>
                 `;
            }
          }

          // Fetch Inquiries (For OAH Notification)
          const inqResponse = await fetch(
            `${API_URL}/inquiries/patient/${userId}`,
          );
          if (inqResponse.ok) {
            const inquiries = await inqResponse.json();
            const acceptedInq = inquiries.find((i) => i.status === "accepted"); //

            const noticeContainer =
              document.getElementById("oahNoticeContainer");

            if (acceptedInq) {
              const comm = acceptedInq.community || {};
              // Create container if not exists
              if (!noticeContainer) {
                const section = document.createElement("div");
                section.id = "oahNoticeContainer";
                section.className = "animate-slide";
                section.style.marginTop = "30px";
                section.innerHTML = `
                      <div class="glass-card" style="background: #ecfdf5; border-color: #a7f3d0; display: flex; gap: 20px; align-items: center;">
                         <img src="${comm.image_url || "https://via.placeholder.com/100"}" 
                              style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover;" />
                         <div style="flex: 1;">
                            <h3 style="color: #065f46; font-weight: 800; margin-bottom: 5px;">
                               âœ… Your Old Age Home booking was successful!
                            </h3>
                            <p style="color: #047857; font-size: 0.95rem;">
                               <strong>${comm.name || "Community"}</strong> has accepted your request. They will contact you shortly.
                            </p>
                            <p style="margin-top: 5px; color: #047857; font-size: 0.9rem;">
                               <i class="fas fa-phone-alt"></i> ${comm.phone || "Contact Admin"}
                            </p>
                         </div>
                      </div>
                   `;
                // Insert after tracking container or before stats
                const tracker = document.getElementById(
                  "liveTrackingContainer",
                );
                tracker.parentNode.insertBefore(section, tracker.nextSibling);
              }
            }
          }
        } catch (e) {
          console.error("Auto-refresh error:", e);
        } finally {
          isRequestInProgress = false;
        }
      }

      function updateTimeline(status) {
        const map = {
          pending: 0,
          confirmed: 10,
          "on-the-way": 40,
          arrived: 75,
          completed: 100,
        };
        const percent = map[status] || 0;

        // Update Progress Bar
        const bar = document.getElementById("progress-bar");
        if (bar) bar.style.width = percent + "%";

        // Reset Icons
        ["icon-way", "icon-arrived", "icon-completed"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("active", "completed");
        });

        // Update Text & Icons
        const statusText = document.getElementById("status-text");
        const etaText = document.getElementById("txt-eta");

        if (status === "on-the-way") {
          document.getElementById("icon-way").classList.add("active");
          statusText.innerText = "Nurse is on the way";
          etaText.innerText = "ETA: 10 Mins";
        } else if (status === "arrived") {
          document.getElementById("icon-way").classList.add("completed");
          document.getElementById("icon-arrived").classList.add("active");
          statusText.innerText = "Nurse has arrived!";
          etaText.innerText = "Arrived";
        } else if (status === "completed") {
          document.getElementById("icon-way").classList.add("completed");
          document.getElementById("icon-arrived").classList.add("completed");
          document.getElementById("icon-completed").classList.add("completed");
          statusText.innerText = "Visit Completed";
          etaText.innerText = "Completed";
        } else if (status === "confirmed") {
          statusText.innerText = "Appointment Confirmed";
          etaText.innerText = "Scheduled";
        } else {
          statusText.innerText = "Waiting for confirmation...";
          etaText.innerText = "Pending";
        }
      }
    </script>
  </body>
</html>
