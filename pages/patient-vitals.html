<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Vitals | ElderConnect Patient</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/patient.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="index.html" class="nav-brand">
        <i class="fas fa-hand-holding-medical"></i> ElderConnect
      </a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="patient-dashboard.html" class="nav-link"><i class="fas fa-home"></i> Home</a>
        </li>
        <li class="nav-item">
          <a href="patient-appointments.html" class="nav-link"><i class="fas fa-calendar-check"></i> Appointments</a>
        </li>
        <li class="nav-item">
          <a href="patient-senior-living.html" class="nav-link"><i class="fas fa-hotel"></i> Senior Living</a>
        </li>
        <li class="nav-item">
          <a href="patient-vitals.html" class="nav-link active"><i class="fas fa-chart-line"></i> Health Vitals</a>
        </li>
        <li class="nav-item">
          <a href="patient-profile.html" class="nav-link"><i class="fas fa-user-circle"></i> My Profile</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </div>
    

    <main class="main-content">
      <header class="section-head">
        <h1 class="page-title">Health Vitals Dashboard</h1>
        <button class="btn btn-primary">
          <i class="fas fa-download"></i> Export Data
        </button>
      </header>

      <div class="vitals-grid" id="vitalsGrid">
        <!-- Vitals cards will be injected here -->
        <p style="text-align: center; width: 100%; grid-column: span 4;">Loading vitals...</p>
      </div>

      <!-- AI Insight -->
      <div class="glass-card animate-slide" style="
            margin-top: 30px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
          ">
        <div style="display: flex; gap: 20px; align-items: start">
          <div style="
                width: 50px;
                height: 50px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
              ">
            <i class="fas fa-robot"></i>
          </div>
          <div>
            <h3 style="font-weight: 800; margin-bottom: 5px">
              AI Health Analysis
            </h3>
            <p style="font-size: 0.95rem; opacity: 0.9; line-height: 1.5" id="aiAnalysisText">
              Data insufficient for full analysis. Please upload recent vitals.
            </p>
          </div>
        </div>
      </div>

      <!-- Historical Data -->
      <div class="glass-card animate-slide" style="margin-top: 30px; animation-delay: 0.2s">
        <h3 style="font-weight: 800; margin-bottom: 20px">
          Historical Measurements
        </h3>
        <table style="width: 100%; border-collapse: collapse">
          <thead>
            <tr style="border-bottom: 2px solid #e2e8f0; text-align: left">
              <th style="padding: 15px; color: #64748b; font-size: 0.8rem; text-transform: uppercase;">Date</th>
              <th style="padding: 15px; color: #64748b; font-size: 0.8rem; text-transform: uppercase;">Time</th>
              <th style="padding: 15px; color: #64748b; font-size: 0.8rem; text-transform: uppercase;">Type</th>
              <th style="padding: 15px; color: #64748b; font-size: 0.8rem; text-transform: uppercase;">Value</th>
              <th style="padding: 15px; color: #64748b; font-size: 0.8rem; text-transform: uppercase;">Unit</th>
            </tr>
          </thead>
          <tbody id="vitalsHistoryBody">
            <!-- Dynamic Rows -->
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <script src="../js/main.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const grid = document.getElementById("vitalsGrid");
      const historyBody = document.getElementById("vitalsHistoryBody");

      const userStr = localStorage.getItem("user");
      if (!userStr) return;
      const user = JSON.parse(userStr);

      try {
        const response = await fetch(`http://localhost:8000/vitals/patient/${user.id}`);
        const vitals = await response.json();

        grid.innerHTML = "";
        historyBody.innerHTML = "";

        if (vitals.length === 0) {
          grid.innerHTML = "<p>No vitals recorded yet.</p>";
          document.getElementById("aiAnalysisText").innerText = "No data available for analysis.";
          return;
        }

        document.getElementById("aiAnalysisText").innerText = "Based on your recent uploads, monitoring continues correctly.";

       
        vitals.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        
        const measurements = [];
        vitals.forEach(record => {
          const date = record.created_at;
          if (record.blood_pressure) {
            measurements.push({ vital_type: "Blood Pressure", value: record.blood_pressure, unit: "mmHg", date: date, color: "#3b82f6", icon: "fa-heartbeat", bg: "#eff6ff" });
          }
          if (record.heart_rate) {
            measurements.push({ vital_type: "Heart Rate", value: record.heart_rate, unit: "BPM", date: date, color: "#ef4444", icon: "fa-running", bg: "#fef2f2" });
          }
          if (record.sugar_level) {
            measurements.push({ vital_type: "Blood Sugar", value: record.sugar_level, unit: "mg/dL", date: date, color: "#10b981", icon: "fa-tint", bg: "#f0fdf4" });
          }
          if (record.temperature) {
            measurements.push({ vital_type: "Temperature", value: record.temperature, unit: "Â°F", date: date, color: "#f97316", icon: "fa-thermometer-half", bg: "#fff7ed" });
          }
        });

        
        const latestByType = {};
        measurements.forEach(m => {
          if (!latestByType[m.vital_type]) {
            latestByType[m.vital_type] = m;
          }
        });

        
        for (let type in latestByType) {
          const v = latestByType[type];
          const card = `
              <div class="vital-card">
                <div class="vital-header">
                  <div class="vital-icon" style="background: ${v.bg}; color: ${v.color}">
                    <i class="fas ${v.icon}"></i>
                  </div>
                  <span class="trend-badge" style="background: #f8fafc; color: #64748b">Latest</span>
                </div>
                <div class="vital-value">${v.value} <small class="vital-unit">${v.unit}</small></div>
                <div style="margin-top: 5px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;">
                  ${v.vital_type}
                </div>
                 <div style="margin-top: 5px; text-align: right; color: ${v.color}; font-size: 0.75rem; font-weight: 700;">
                  ${new Date(v.date).toLocaleDateString()}
                </div>
              </div>
            `;
          grid.insertAdjacentHTML('beforeend', card);
        }

      
        measurements.slice(0, 15).forEach(m => {
          const dateObj = new Date(m.date);
          const row = `
                <tr style="border-bottom: 1px solid #f1f5f9">
                    <td style="padding: 20px 15px; font-weight: 600">${dateObj.toLocaleDateString()}</td>
                    <td style="padding: 20px 15px; color: #64748b">${dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td style="padding: 20px 15px">${m.vital_type}</td>
                    <td style="padding: 20px 15px; font-weight: 700">${m.value}</td>
                    <td style="padding: 20px 15px">${m.unit}</td>
                </tr>
            `;
          historyBody.insertAdjacentHTML('beforeend', row);
        });

      } catch (e) {
        console.error(e);
        grid.innerHTML = "<p>Error loading vitals.</p>";
      }
    });
  </script>
  </main>
  </div>
  <script src="../js/main.js"></script>
</body>

</html>
